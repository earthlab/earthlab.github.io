---
layout: single
title: "An example of creating modular code in R - Efficient scientific programming"
excerpt: "This lesson provides an example of modularizing code in R. "
authors: ['Carson Farmer', 'Leah Wasser']
modified: '2017-03-27'
category: [course-materials]
class-lesson: ['intro-APIs-r']
permalink: /course-materials/earth-analytics/week-10/apis2-r/
nav-title: 'Work with API 2'
week: 10
sidebar:
  nav:
author_profile: false
comments: true
order: 3
---

{% include toc title="In This Lesson" icon="file-text" %}

<div class='notice--success' markdown="1">

## <i class="fa fa-graduation-cap" aria-hidden="true"></i> Learning Objectives

After completing this tutorial, you will be able to:

*

## <i class="fa fa-check-square-o fa-2" aria-hidden="true"></i> What you need

You will need a computer with internet access to complete this lesson and the
data that we already downloaded for week 6 of the course.

{% include/data_subsets/course_earth_analytics/_data-week6-7.md %}
</div>



In the previous lesson, we learned how to access human readable text files data 
programmatically using:

1. download.file() to download a file to your computer and work with it
1. read.csv() to read in a tabular file stored on a web location. 
1. using getURL() to read in data files that may be secure (https://) or that require more advanced protocols.

In this lesson, we will learn more about API interfaces - which return data that 
are *machine readable* and thus are more efficient - particularly for larger 
data!  In this lesson, the getURL() function will become more valuable to us 
as we parse data accessed from an API. 


```r
library("knitr")
library("dplyr")
library("ggplot2")
library("leaflet")
```


## stuff about the rest api - as a reminder 
* where they can get information to figure out how to get the data
* show the website
* steps - what they need toknow
* download data
* homework - maybe have them download data for different age ranges and some other county?
* they can use the API documentation to figure out what to parse... 


Accessing API Data via getURL
========================================================

- `getURL` is similar to before, this time adding `URL` parameters:


```r
# Base URL path
base = "https://data.colorado.gov/resource/tv8u-hswn.json?"
full = paste0(base, "county=Boulder",
              "&$where=age between 20 and 40",
              "&$select=year,age,femalepopulation")
res = getURL(URLencode(full))
```
- Since this is encoded as `JSON`, we'll need to parse it:

Will need to teach them about JSON as a data structure. This is new and different
and likely worth learning! 

* will need to provide some background - how do we find the categories to get the data we want?
* apply is a new function -- useful to teach
* could add ahomeowkr question to create a slightly difference plot with differen variables.


```r
library(rjson)
library(jsonlite)

# get data - notice they are in json format
json_text = fromJSON(res)  # Parse JSON
json_text
##      age femalepopulation year
## 1     30             2376 1995
## 2     28             2175 1998
## 3     39             2259 1992
## 4     25             1832 1991
## 5     39             2326 1993
## 6     35             2313 1999
## 7     39             2360 1994
## 8     36             2302 1995
## 9     33             2296 1991
## 10    35             2263 1990
## 11    23             1884 1992
## 12    33             2227 1996
## 13    20             2779 1999
## 14    20          2751.00 1990
## 15    21          2615.00 1990
## 16    22          2167.00 1990
## 17    23          1798.00 1990
## 18    24          1692.00 1990
## 19    25          1813.00 1990
## 20    26          1934.00 1990
## 21    27          2094.00 1990
## 22    28          2045.00 1990
## 23    29          2297.00 1990
## 24    30          2315.00 1990
## 25    31          2278.00 1990
## 26    32          2328.00 1990
## 27    33          2328.00 1990
## 28    34          2414.00 1990
## 29    36          2229.00 1990
## 30    37          2263.00 1990
## 31    38          2132.00 1990
## 32    39          2176.00 1990
## 33    40          2082.00 1990
## 34    20          2736.00 1991
## 35    21          2612.00 1991
## 36    22          2207.00 1991
## 37    23          1830.00 1991
## 38    24          1726.00 1991
## 39    26          1932.00 1991
## 40    27          2090.00 1991
## 41    28          2051.00 1991
## 42    29          2273.00 1991
## 43    30          2310.00 1991
## 44    31          2253.00 1991
## 45    32          2286.00 1991
## 46    34          2368.00 1991
## 47    35          2255.00 1991
## 48    36          2228.00 1991
## 49    37          2275.00 1991
## 50    38          2157.00 1991
## 51    39          2204.00 1991
## 52    40          2132.00 1991
## 53    20          2763.00 1992
## 54    21          2647.00 1992
## 55    22          2271.00 1992
## 56    24          1778.00 1992
## 57    25          1874.00 1992
## 58    26          1958.00 1992
## 59    27          2116.00 1992
## 60    28          2085.00 1992
## 61    29          2285.00 1992
## 62    30          2338.00 1992
## 63    31          2263.00 1992
## 64    32          2282.00 1992
## 65    33          2302.00 1992
## 66    34          2363.00 1992
## 67    35          2279.00 1992
## 68    36          2257.00 1992
## 69    37          2316.00 1992
## 70    38          2207.00 1992
## 71    40          2204.00 1992
## 72    20          2802.00 1993
## 73    21          2694.00 1993
## 74    22          2350.00 1993
## 75    23          1949.00 1993
## 76    24          1841.00 1993
## 77    25          1927.00 1993
## 78    26          1993.00 1993
## 79    27          2152.00 1993
## 80    28          2129.00 1993
## 81    29          2307.00 1993
## 82    30          2377.00 1993
## 83    31          2283.00 1993
## 84    32          2287.00 1993
## 85    33          2316.00 1993
## 86    34          2366.00 1993
## 87    35          2314.00 1993
## 88    36          2298.00 1993
## 89    37          2370.00 1993
## 90    38          2270.00 1993
## 91    40          2289.00 1993
## 92    20          2799.00 1994
## 93    21          2701.00 1994
## 94    22          2395.00 1994
## 95    23          1986.00 1994
## 96    24          1878.00 1994
## 97    25          1952.00 1994
## 98    26          1999.00 1994
## 99    27          2156.00 1994
## 100   28          2142.00 1994
## 101   29          2293.00 1994
## 102   30          2381.00 1994
## 103   31          2268.00 1994
## 104   32          2255.00 1994
## 105   33          2295.00 1994
## 106   34          2332.00 1994
## 107   35          2314.00 1994
## 108   36          2304.00 1994
## 109   37          2388.00 1994
## 110   38          2300.00 1994
## 111   40          2343.00 1994
## 112   20          2786.00 1995
## 113   21          2699.00 1995
## 114   22          2433.00 1995
## 115   23          2018.00 1995
## 116   24          1911.00 1995
## 117   25          1971.00 1995
## 118   26          1997.00 1995
## 119   27          2152.00 1995
## 120   28          2147.00 1995
## 121   29          2270.00 1995
## 122   31          2243.00 1995
## 123   32          2214.00 1995
## 124   33          2265.00 1995
## 125   34          2288.00 1995
## 126   35          2306.00 1995
## 127   37          2399.00 1995
## 128   38          2324.00 1995
## 129   39          2386.00 1995
## 130   40          2391.00 1995
## 131   20          2764.00 1996
## 132   21          2690.00 1996
## 133   22          2467.00 1996
## 134   23          2045.00 1996
## 135   24          1939.00 1996
## 136   25          1985.00 1996
## 137   26          1990.00 1996
## 138   27          2142.00 1996
## 139   28          2147.00 1996
## 140   29          2241.00 1996
## 141   30          2365.00 1996
## 142   31          2213.00 1996
## 143   32          2166.00 1996
## 144   34          2236.00 1996
## 145   35          2291.00 1996
## 146   36          2294.00 1996
## 147   37          2404.00 1996
## 148   38          2341.00 1996
## 149   39          2408.00 1996
## 150   40          2434.00 1996
## 151   20          2741.00 1997
## 152   21          2679.00 1997
## 153   22          2501.00 1997
## 154   23          2073.00 1997
## 155   24          1968.00 1997
## 156   25          1999.00 1997
## 157   26          1982.00 1997
## 158   27          2131.00 1997
## 159   28          2147.00 1997
## 160   29          2209.00 1997
## 161   30          2353.00 1997
## 162   31          2180.00 1997
## 163   32          2116.00 1997
## 164   33          2187.00 1997
## 165   34          2181.00 1997
## 166   35          2275.00 1997
## 167   36          2285.00 1997
## 168   37          2408.00 1997
## 169   38          2359.00 1997
## 170   39          2429.00 1997
## 171   40          2477.00 1997
## 172   20          2754.00 1998
## 173   21          2703.00 1998
## 174   22          2569.00 1998
## 175   23          2130.00 1998
## 176   24          2024.00 1998
## 177   25          2041.00 1998
## 178   26          2000.00 1998
## 179   27          2148.00 1998
## 180   29          2206.00 1998
## 181   30          2371.00 1998
## 182   31          2174.00 1998
## 183   32          2091.00 1998
## 184   33          2175.00 1998
## 185   34          2154.00 1998
## 186   35          2289.00 1998
## 187   36          2305.00 1998
## 188   37          2445.00 1998
## 189   38          2409.00 1998
## 190   39          2484.00 1998
## 191   40          2556.00 1998
## 192   21          2741.00 1999
## 193   22          2654.00 1999
## 194   23          2200.00 1999
## 195   24          2092.00 1999
## 196   25          2094.00 1999
## 197   26          2029.00 1999
## 198   27          2175.00 1999
## 199   28          2214.00 1999
## 200   29          2212.00 1999
## 201   30          2401.00 1999
## 202   31          2178.00 1999
## 203   32          2074.00 1999
## 204   33          2171.00 1999
## 205   34          2133.00 1999
## 206   36          2338.00 1999
## 207   37          2494.00 1999
## 208   38          2473.00 1999
## 209   39          2553.00 1999
## 210   40          2651.00 1999
## 211   20          3516.00 2010
## 212   21          3312.00 2010
## 213   22          2837.00 2010
## 214   23          2202.00 2010
## 215   24          1992.00 2010
## 216   25          2017.00 2010
## 217   26          1851.00 2010
## 218   27          1843.00 2010
## 219   28          1937.00 2010
## 220   29          1909.00 2010
## 221   30          2014.00 2010
## 222   31          1882.00 2010
## 223   32          1851.00 2010
## 224   33          1888.00 2010
## 225   34          1841.00 2010
## 226   35          1964.00 2010
## 227   36          1901.00 2010
## 228   37          1912.00 2010
## 229   38          2007.00 2010
## 230   39          2097.00 2010
## 231   40          2294.00 2010
## 232   25             2420 2033
## 233   32             1833 2015
## 234   32             2007 2024
## 235   33             2151 2030
## 236   35             1950 2016
## 237   38             2346 2036
## 238   37             2039 2019
## 239   22             2851 2008
## 240   38             2053 2013
## 241   24             2009 2014
## 242   36             2202 2000
## 243   30             2087 2025
## 244   40             2137 2005
## 245   26             1985 2019
## 246   29             1952 2014
## 247   23             2824 2037
## 248   33             2264 2036
## 249   34             1955 2005
## 250   22             3207 2016
## 251   21             3587 2015
## 252   29             1688 2016
## 253   25             1944 2011
## 254   25             2014 2003
## 255   35             2200 2032
## 256   31             1755 2019
## 257   29             1761 2017
## 258   39             2331 2038
## 259   26             2350 2034
## 260   25             2103 2020
## 261   25             2401 2026
## 262   23             2937 2024
## 263   40             2370 2040
## 264   30             2417 2004
## 265   27             2217 2038
## 266   34             1852 2009
## 267   37             2053 2022
## 268   29             2229 2005
## 269   30             1898 2011
## 270   27             2099 2002
## 271   27             1683 2014
## 272   25             2285 2038
## 273   20             3417 2011
## 274   28             1345 2008
## 275   38             2162 2030
## 276   38             1942 2005
## 277   26             1685 2013
## 278   37             2182 2032
## 279   35             1930 2024
## 280   22             3110 2014
## 281   40             2214 2032
## 282   32             1939 2017
## 283   39             2046 2018
## 284   27             2390 2031
## 285   24             2511 2027
## 286   27             1909 2017
## 287   38             2023 2029
## 288   31             2091 2026
## 289   40             2118 2026
## 290   24             2018 2002
## 291   36             2048 2007
## 292   34             2267 2040
## 293   31             2264 2029
## 294   39             2238 2034
## 295   32             2090 2027
## 296   25             2347 2034
## 297   23             2369 2014
## 298   24             2555 2028
## 299   33             1842 2011
## 300   32             1926 2007
## 301   36             1986 2011
## 302   21             3776 2036
## 303   21             3950 2027
## 304   33             2085 2028
## 305   20             3786 2017
## 306   37             1815 2005
## 307   33             1852 2022
## 308   23             1800 2005
## 309   32             2118 2001
## 310   20             3328 2003
## 311   26             2382 2029
## 312   32             2306 2036
## 313   20             3929 2032
## 314   40             2092 2021
## 315   29             1843 2018
## 316   24             1834 2008
## 317   34             1957 2024
## 318   38             2408 2001
## 319   28             2349 2033
## 320   38             1982 2022
## 321   24             2333 2038
## 322   23             2833 2038
## 323   39             2041 2011
## 324   35             1934 2014
## 325   36             2216 2033
## 326   23             2874 2034
## 327   33             1936 2015
## 328   31             2191 2040
## 329   40             2350 2039
## 330   31             2300 2034
## 331   35             2075 2007
## 332   40             2087 2017
## 333   25             1900 2008
##  [ reached getOption("max.print") -- omitted 667 rows ]

# convert EACH row to a numeric format
json_text$age <- as.numeric(json_text$age)
json_text$year <- as.numeric(json_text$year)
json_text$femalepopulation <- as.numeric(json_text$femalepopulation)

# OR use the apply function to convert all rows in the DF to numbers
pops <- as.data.frame(lapply(json_text, as.numeric))

ggplot(json_text, aes(x=year, y=femalepopulation,
  group=factor(age), color=age)) + geom_line()
```

<img src="{{ site.url }}/images/rfigs/course-materials/earth-analytics/week-10/in-class/2016-12-06-api03-next-r/unnamed-chunk-4-1.png" title=" " alt=" " width="100%" />

```r

# fromJSON(res) %>% as.data.frame

# pops = do.call("rbind", json_text)  # Combine rows
# Convert to data.frame with numeric columns
# pops = as.data.frame(apply(pops, 2, as.numeric))
```

Plot Projected Populations
========================================================
title: false


```r
ggplot(pops, aes(x=year, y=femalepopulation,
  group=factor(age), color=age)) + geom_line()
```

<center>

```
## Error in eval(expr, envir, enclos): object 'pres_theme' not found
```
</center>
