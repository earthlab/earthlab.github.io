---
layout: single
title: "An example of creating modular code in R - Efficient scientific programming"
excerpt: "This lesson provides an example of modularizing code in R. "
authors: ['Carson Farmer', 'Leah Wasser']
modified: '`r format(Sys.time(), "%Y-%m-%d")`'
category: [course-materials]
class-lesson: ['intro-APIs-r']
permalink: /course-materials/earth-analytics/week-10/apis2-r/
nav-title: 'Work with API 2'
week: 10
sidebar:
  nav:
author_profile: false
comments: true
order: 3
---

{% include toc title="In This Lesson" icon="file-text" %}

<div class='notice--success' markdown="1">

## <i class="fa fa-graduation-cap" aria-hidden="true"></i> Learning Objectives

After completing this tutorial, you will be able to:

*

## <i class="fa fa-check-square-o fa-2" aria-hidden="true"></i> What you need

You will need a computer with internet access to complete this lesson and the
data that we already downloaded for week 6 of the course.

{% include/data_subsets/course_earth_analytics/_data-week6-7.md %}
</div>

```{r echo=F}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning=FALSE)

```

In the previous lesson, we learned how to access human readable text files data
programmatically using:

1. `download.file()` to download a file to your computer and work with it
1. `read.csv()` to read in a tabular file stored on a web location.
1. using `getURL()` to read in data files that may be secure (https://) or that require more advanced protocols.

In this lesson, we will learn more about API interfaces - which return data that
are *machine readable* and thus are more efficient - particularly for larger
data. In this lesson, the `getURL()` function will become more valuable to us
as we parse data accessed from an API.

## Review - about APIs

Remember we have covered

* where they can get information to figure out how to get the data
* show the website
* steps - what they need to know
* download data
* homework - maybe have them download data for different age ranges and some other county?
* they can use the API documentation to figure out what to parse...

```{r}
library("knitr")
library("dplyr")
library("ggplot2")
```

## Review

remember that in the first lesson in this module, we discussed RESTful APIs .
The request to an RESTful API includes a

1. URL which defines the location of the data in the web server
2. The request which includes the URL AND the associated parameters required to access a particular subset of the data that we wish to access
3. What the web API returns - which is either the data that we requested or a failed to return message which tells us that something was wrong with our request.


### Colorado Population Projections

The [Colorado Information Marketplace](https://data.colorado.gov) is a
comprehensive data warehouse with access to a wide range of Colorado-specific
open datasets available via a RESTful API called the Socrata Open Data API (SODA)

There are lots of API *endpoints* or data sets available via this API. One
endpoint contains  <a href="https://data.colorado.gov/resource/tv8u-hswn.json" target="_blank">Colorado Population Projections:</a>.
If you go to this site, you will see data returned
in a `JSON` format. These data includes population estimates for *males* and
*females* for every *county* in Colorado for every *year* from 1990 to 2040 for
multiple *age* groups!

### URL Parameters

Using `URL` parameters, we can define a more specific request to limit what data
we get back in response to our API request. For example, if we only want data for
Boulder, Colorado, we can query just that subset of the data using the RESTful call.

note the **?&county=Boulder** part of the url:

<a href="https://data.colorado.gov/resource/tv8u-hswn.json?&county=Boulder" target="_blank">Like this - https://data.colorado.gov/resource/tv8u-hswn.json?&county=Boulder</a>.

Parameters associated with accessing data using this API are <a href="https://dev.socrata.com/foundry/data.colorado.gov/tv8u-hswn" target="_blank">documented here</a>.

## Using SOAP

`SOAP` also allows us to specify more complex 'queries'. Here's the API `URL`
for population projections for female Boulderites aged 20--40 for the years 2016-2025:

<a href="https://data.colorado.gov/resource/tv8u-hswn.json?$where=age between 20 and 40 and year between 2016 and 2025&county=Boulder&$select=year,age,femalepopulation" target="_blank"> https://data.colorado.gov/resource/tv8u-hswn.json?$where=age between 20 and 40 and year between 2016 and 2025&county=Boulder&$select=year,age,femalepopulation</a>.

### API Response

The data that are returned from an API are called the response. The format of the
returned data or the response is most often in the form of plain text 'file'
such as a `JSON` or `CSV` file.

For many APIs, you can specify the file [that you want to be returned](https://dev.socrata.com/docs/formats/index.html).


## Accessing API Data via getURL

We will use the `getURL()` in the same way that we used it before. however, this
time we will add the `URL` parameters that specify which subset of the data
that we want to access. 

```{r}
# Base URL path
base_url = "https://data.colorado.gov/resource/tv8u-hswn.json?"
full_url = paste0(base, "county=Boulder",
              "&$where=age between 20 and 40",
              "&$select=year,age,femalepopulation")
# view full url
full
# get the data from the specified url
res = getURL(URLencode(full))
```

- Since this is encoded as `JSON`, we'll need to parse it:

Will need to teach them about JSON as a data structure. This is new and different
and likely worth learning!

* will need to provide some background - how do we find the categories to get the data we want?
* apply is a new function -- useful to teach
* could add ahomeowkr question to create a slightly difference plot with differen variables.

```{r}
library(rjson)
library(jsonlite)

# get data - notice they are in json format
json_text = fromJSON(res)  # Parse JSON
json_text

# convert EACH row to a numeric format
json_text$age <- as.numeric(json_text$age)
json_text$year <- as.numeric(json_text$year)
json_text$femalepopulation <- as.numeric(json_text$femalepopulation)

# OR use the apply function to convert all rows in the DF to numbers
pops <- as.data.frame(lapply(json_text, as.numeric))

ggplot(json_text, aes(x=year, y=femalepopulation,
  group=factor(age), color=age)) + geom_line()

# fromJSON(res) %>% as.data.frame

# pops = do.call("rbind", json_text)  # Combine rows
# Convert to data.frame with numeric columns
# pops = as.data.frame(apply(pops, 2, as.numeric))
```

Plot Projected Populations
========================================================
title: false

```{r eval=FALSE}
ggplot(pops, aes(x=year, y=femalepopulation,
  group=factor(age), color=age)) + geom_line()
```

<center>
```{r echo=FALSE, fig.width=10, fig.height=6}
ggplot(pops, aes(x=year, y=femalepopulation,
                 group=factor(age),
                 color=age)) +
  geom_line() + pres_theme
```
</center>
